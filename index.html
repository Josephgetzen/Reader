<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSync | Pro RSVP Engine</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #f0f0f0;
            --accent-color: #00ff9d;
            --pivot-color: #ff3333;
            --ui-gray: #222;
            --border: #333;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Courier New', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Transitions --- */
        .view {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
            background: var(--bg-color);
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            z-index: -1;
        }

        /* --- Input View --- */
        .input-container {
            width: 90%;
            max-width: 650px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        h1 {
            font-weight: 300;
            text-align: center;
            letter-spacing: 4px;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-transform: uppercase;
            font-size: 2rem;
        }

        .settings-bar {
            display: flex;
            gap: 10px;
            background: var(--ui-gray);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .setting-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, input[type="range"] {
            background: #111;
            color: white;
            border: 1px solid #444;
            padding: 5px;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
        }
        
        select { cursor: pointer; }

        textarea {
            width: 100%;
            height: 250px;
            background: var(--ui-gray);
            border: 1px solid var(--border);
            color: #ddd;
            padding: 20px;
            font-size: 18px;
            line-height: 1.6;
            border-radius: 8px;
            resize: none;
            outline: none;
            font-family: var(--font-mono);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        textarea:focus { border-color: var(--accent-color); }

        .meta-row {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.8rem;
        }

        button.primary-btn {
            padding: 18px;
            background: var(--accent-color);
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        button.primary-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
        }

        /* --- Reader View --- */
        .rsvp-stage {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Guides for the eye */
            border-top: 1px solid #222;
            border-bottom: 1px solid #222;
        }

        /* The Reticle */
        .reticle-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background: rgba(50, 50, 50, 0.5);
            transform: translateX(-50%);
            z-index: 0;
        }
        
        .reticle-marker::before, .reticle-marker::after {
            content: '';
            position: absolute;
            left: -5px;
            width: 12px;
            height: 2px;
            background: #444;
        }
        .reticle-marker::before { top: 30%; }
        .reticle-marker::after { bottom: 30%; }

        .word-container {
            font-size: 4rem; /* Massive text */
            display: flex;
            align-items: baseline;
            white-space: nowrap;
            z-index: 1;
            font-family: var(--font-mono); /* Monospace helps alignment consistency */
            font-weight: 500;
        }

        .w-left {
            text-align: right;
            color: #888;
        }

        .w-pivot {
            color: var(--pivot-color);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 51, 51, 0.4);
            /* Important: ensuring pivot character aligns to center */
            display: inline-block;
            transform: translateX(0px); 
        }

        .w-right {
            text-align: left;
            color: #888;
        }

        .controls-overlay {
            margin-top: 80px;
        }

        .back-btn {
            background: transparent;
            border: 1px solid #444;
            color: #888;
            padding: 10px 40px;
            border-radius: 30px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: 0.2s;
        }

        .back-btn:hover {
            border-color: var(--pivot-color);
            color: var(--pivot-color);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: var(--accent-color);
            font-family: var(--font-mono);
        }
    </style>
</head>
<body>

    <!-- INPUT VIEW -->
    <div id="view-input" class="view">
        <div class="input-container">
            <h1>NeuroSync <span style="font-size:0.5em; vertical-align:top; opacity:0.5;">v2</span></h1>
            
            <div class="settings-bar">
                <div class="setting-group">
                    <label>Voice Model</label>
                    <select id="voice-select">
                        <option value="">Loading voices...</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Speed: <span id="speed-val">0.8</span>x</label>
                    <input type="range" id="rate-range" min="0.5" max="2.0" step="0.1" value="0.8">
                </div>
            </div>

            <textarea id="text-input" maxlength="4000" placeholder="Enter text stream to synchronize..."></textarea>
            
            <div class="meta-row">
                <span>MAX 4000 CHARS</span>
                <span id="char-count">0/4000</span>
            </div>

            <button id="btn-start" class="primary-btn">Initialize Stream</button>
        </div>
    </div>

    <!-- READER VIEW -->
    <div id="view-reader" class="view hidden">
        <div class="rsvp-stage">
            <div class="reticle-marker"></div>
            <div class="word-container">
                <span class="w-left" id="rsvp-left"></span>
                <span class="w-pivot" id="rsvp-pivot"></span>
                <span class="w-right" id="rsvp-right"></span>
            </div>
        </div>

        <div class="controls-overlay">
            <button id="btn-stop" class="back-btn">Terminate Stream</button>
        </div>
    </div>

    <script>
        /**
         * NEUROSYNC V2 - High Performance RSVP
         * 
         * Algorithm:
         * 1. Text Analysis: Regex-based tokenization preserving punctuation structure.
         * 2. Audio Generation: Web Speech API.
         * 3. Synchronization: Event-driven 'boundary' detection (Zero-Latency).
         * 4. Visual Alignment: Optical Center Calculation (Inner-Vowel Logic).
         */

        const STATE = {
            voices: [],
            utterance: null,
            isReading: false
        };

        const UI = {
            views: {
                input: document.getElementById('view-input'),
                reader: document.getElementById('view-reader')
            },
            input: {
                text: document.getElementById('text-input'),
                count: document.getElementById('char-count'),
                voiceSelect: document.getElementById('voice-select'),
                rateRange: document.getElementById('rate-range'),
                speedDisplay: document.getElementById('speed-val'),
                startBtn: document.getElementById('btn-start')
            },
            reader: {
                left: document.getElementById('rsvp-left'),
                pivot: document.getElementById('rsvp-pivot'),
                right: document.getElementById('rsvp-right'),
                stopBtn: document.getElementById('btn-stop')
            }
        };

        const CONSTANTS = {
            VOWELS: /[aeiouy]/i,
            PUNCTUATION: /[.,\/#!$%\^&\*;:{}=\-_`~()]/g
        };

        // --- Initialization ---

        function init() {
            // Setup Text Area
            UI.input.text.addEventListener('input', (e) => {
                UI.input.count.innerText = `${e.target.value.length}/4000`;
            });

            // Setup Speed Slider
            UI.input.rateRange.addEventListener('input', (e) => {
                UI.input.speedDisplay.innerText = e.target.value;
            });

            // Setup Buttons
            UI.input.startBtn.addEventListener('click', startStream);
            UI.reader.stopBtn.addEventListener('click', stopStream);

            // Load Voices
            loadVoices();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
            }
        }

        function loadVoices() {
            STATE.voices = window.speechSynthesis.getVoices();
            
            if (STATE.voices.length === 0) return;

            UI.input.voiceSelect.innerHTML = '';
            
            // Sort voices: Prioritize "Google", "Microsoft", or "Natural"
            STATE.voices.sort((a, b) => {
                const aName = a.name.toLowerCase();
                const bName = b.name.toLowerCase();
                const scoreA = (aName.includes('google') || aName.includes('natural')) ? 1 : 0;
                const scoreB = (bName.includes('google') || bName.includes('natural')) ? 1 : 0;
                return scoreB - scoreA;
            });

            STATE.voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                // Add a star to likely high-quality voices
                const label = `${voice.name} (${voice.lang})`;
                option.textContent = label;
                if (voice.default) option.selected = true;
                UI.input.voiceSelect.appendChild(option);
            });
        }

        // --- The Core Algorithm (ORP) ---

        /**
         * Calculates where to split the word based on the "Inner Vowel" rule.
         */
        function getPivotIndex(word) {
            const len = word.length;
            
            // Rule 1: Too short for "inner" logic? Center it.
            if (len <= 2) return Math.floor(len / 2);

            // Rule 2: Scan the "Inner" word (excluding first and last char)
            // inner start index = 1, inner end index = len - 2
            // We iterate through the original word but only check indices 1 to len-2
            
            for (let i = 1; i < len - 1; i++) {
                if (CONSTANTS.VOWELS.test(word[i])) {
                    return i; // Found the first inner vowel
                }
            }

            // Rule 3: No inner vowels? Geometric center.
            return Math.floor(len / 2);
        }

        function renderFrame(word) {
            if (!word) return;

            const pivotIndex = getPivotIndex(word);
            
            const leftStr = word.substring(0, pivotIndex);
            const pivotChar = word[pivotIndex];
            const rightStr = word.substring(pivotIndex + 1);

            UI.reader.left.innerText = leftStr;
            UI.reader.pivot.innerText = pivotChar;
            UI.reader.right.innerText = rightStr;
        }

        // --- Stream Logic ---

        function startStream() {
            const text = UI.input.text.value.trim();
            if (!text) {
                alert("Buffer empty. Please input text data.");
                return;
            }

            // Lock UI
            UI.views.input.classList.add('hidden');
            UI.views.reader.classList.remove('hidden');
            STATE.isReading = true;

            // Prepare Utterance
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Apply Settings
            const selectedVoiceIndex = UI.input.voiceSelect.value;
            if (STATE.voices[selectedVoiceIndex]) {
                utterance.voice = STATE.voices[selectedVoiceIndex];
            }
            
            utterance.rate = parseFloat(UI.input.rateRange.value);
            utterance.pitch = 1.0;

            // The SYNC ENGINE
            // Chrome/Edge/Safari fire 'boundary' on every word.
            utterance.onboundary = (event) => {
                if (event.name === 'word') {
                    // event.charIndex is the index of the first character of the word
                    const start = event.charIndex;
                    
                    // Algorithm to determine word length in the raw text
                    // We scan forward looking for whitespace
                    let end = text.indexOf(' ', start);
                    if (end === -1) end = text.length; // Handle last word

                    // Extract raw token
                    let rawToken = text.substring(start, end);

                    // Refinement: The TTS engine often treats punctuation as part of the word
                    // or pauses on it. We strip trailing newlines for display.
                    rawToken = rawToken.split(/\s/)[0];

                    requestAnimationFrame(() => renderFrame(rawToken));
                }
            };

            utterance.onend = stopStream;
            utterance.onerror = (e) => {
                console.error("Audio Stream Error", e);
                stopStream();
            };

            STATE.utterance = utterance;

            // Force browser to dump previous buffer
            window.speechSynthesis.cancel();
            
            // Ignite
            setTimeout(() => {
                window.speechSynthesis.speak(utterance);
            }, 100);
        }

        function stopStream() {
            if (!STATE.isReading) return;

            window.speechSynthesis.cancel();
            STATE.utterance = null;
            STATE.isReading = false;

            UI.views.reader.classList.add('hidden');
            UI.views.input.classList.remove('hidden');
            
            // Clean display
            UI.reader.left.innerText = "";
            UI.reader.pivot.innerText = "";
            UI.reader.right.innerText = "";
        }

        // Start
        init();

    </script>
</body>
</html>
